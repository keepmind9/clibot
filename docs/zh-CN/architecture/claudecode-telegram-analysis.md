# Claude Code Telegram Bridge - å·¥ä½œåŸç†åˆ†æ

**åˆ†ææ—¥æœŸ**: 2026-01-29
**é¡¹ç›®**: [claudecode-telegram](https://github.com/hanxiao/claudecode-telegram)

---

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [æ ¸å¿ƒæ–‡ä»¶åˆ†æ](#æ ¸å¿ƒæ–‡ä»¶åˆ†æ)
3. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
4. [å…³é”®è®¾è®¡æ¨¡å¼](#å…³é”®è®¾è®¡æ¨¡å¼)
5. [åº”ç”¨åˆ° clibot](#åº”ç”¨åˆ°-clibot)

---

## ç³»ç»Ÿæ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Webhook
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare  â”‚ Tunnel (å¯é€‰ï¼Œæš´éœ²æœ¬åœ°æœåŠ¡)
â”‚   Tunnel    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bridge      â”‚ Python HTTP Server
â”‚  Server     â”‚ - æ¥æ”¶ Telegram webhook
â”‚  :8080      â”‚ - å†™å…¥çŠ¶æ€æ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ - é€šè¿‡ tmux å‘é€æ¶ˆæ¯
       â”‚
       â”‚ tmux send-keys
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code â”‚ åœ¨ tmux session ä¸­è¿è¡Œ
â”‚  (tmux)     â”‚ - å¤„ç†ç”¨æˆ·æ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ - è§¦å‘ Stop hook
       â”‚
       â”‚ Stop Hook (stdin JSON)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hook Script â”‚ send-to-telegram.sh
â”‚  (bash)     â”‚ - è¯»å–çŠ¶æ€æ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ - è§£æ transcript.jsonl
       â”‚ - å‘é€å›å¤åˆ° Telegram
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ–‡ä»¶åˆ†æ

### 1. çŠ¶æ€æ–‡ä»¶

#### CHAT_ID_FILE (`~/.claude/telegram_chat_id`)

**ä½œç”¨**: å­˜å‚¨å½“å‰äº¤äº’çš„ Telegram Chat ID

**ç”Ÿå‘½å‘¨æœŸ**:
```
[Bridge æ”¶åˆ°æ¶ˆæ¯] â†’ å†™å…¥ chat_id â†’ [Hook è¯»å–] â†’ å‘é€å›å¤ â†’ æ–‡ä»¶ä¿ç•™ï¼ˆä¸‹æ¬¡å¤ç”¨ï¼‰
```

**ä»£ç ä½ç½®**:
- **å†™å…¥**: `bridge.py:168-169`
  ```python
  with open(CHAT_ID_FILE, "w") as f:
      f.write(str(chat_id))
  ```

- **è¯»å–**: `send-to-telegram.sh:19`
  ```bash
  CHAT_ID=$(cat "$CHAT_ID_FILE")
  ```

**è®¾è®¡æ„å›¾**:
- âœ… Bridge æ”¶åˆ°æ¶ˆæ¯æ—¶è®°å½• "å›å¤ç›®æ ‡"
- âœ… Hook è„šæœ¬çŸ¥é“è¦æŠŠ Claude çš„å›å¤å‘é€åˆ°å“ªé‡Œ
- âœ… æŒä¹…åŒ–å­˜å‚¨ï¼Œæ— éœ€é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’

---

#### PENDING_FILE (`~/.claude/telegram_pending`)

**ä½œç”¨**: æ ‡å¿—æ–‡ä»¶ï¼Œè¡¨ç¤º "æ­£åœ¨ç­‰å¾… Claude å›å¤"

**ç”Ÿå‘½å‘¨æœŸ**:
```
[å‘é€æ¶ˆæ¯] â†’ åˆ›å»ºæ–‡ä»¶ â†’ [Hook æ£€æŸ¥] â†’ [å‘é€å›å¤] â†’ åˆ é™¤æ–‡ä»¶
             (å†™å…¥æ—¶é—´æˆ³)    (å­˜åœ¨æ‰å›å¤)      (å®Œæˆ)
```

**ä»£ç ä½ç½®**:

1. **åˆ›å»º**: `bridge.py:250-251`
   ```python
   with open(PENDING_FILE, "w") as f:
       f.write(str(int(time.time())))  # å†™å…¥æ—¶é—´æˆ³
   ```

2. **Hook æ£€æŸ¥**: `send-to-telegram.sh:12`
   ```bash
   # åªå“åº” Telegram å‘èµ·çš„è¯·æ±‚
   [ ! -f "$PENDING_FILE" ] && exit 0
   ```

3. **è¶…æ—¶æ£€æŸ¥**: `send-to-telegram.sh:16`
   ```bash
   # 10åˆ†é’Ÿè¶…æ—¶ï¼Œé˜²æ­¢åƒµå°¸æ–‡ä»¶
   [ -z "$PENDING_TIME" ] || [ $((NOW - PENDING_TIME)) -gt 600 ] && \
       rm -f "$PENDING_FILE" && exit 0
   ```

4. **å‘é€ typing**: `bridge.py:58-61`
   ```python
   def send_typing_loop(chat_id):
       while os.path.exists(PENDING_FILE):  # æ–‡ä»¶å­˜åœ¨å°±æŒç»­å‘é€
           telegram_api("sendChatAction", {"chat_id": chat_id, "action": "typing"})
           time.sleep(4)
   ```

5. **åˆ é™¤**:
   - Hook å‘é€å®Œå›å¤: `send-to-telegram.sh:73`
     ```bash
     rm -f "$TMPFILE" "$PENDING_FILE"
     ```
   - ç”¨æˆ·ä¸­æ–­: `bridge.py:183`
     ```bash
     if os.path.exists(PENDING_FILE):
         os.remove(PENDING_FILE)
     ```

**è®¾è®¡æ„å›¾**:
- âœ… **è¯·æ±‚æ¥æºéªŒè¯**: Hook åªå“åº” Telegram å‘èµ·çš„è¯·æ±‚ï¼ˆé˜²æ­¢æœ¬åœ°æ‰‹åŠ¨è§¦å‘ä¹Ÿå›å¤ï¼‰
- âœ… **çŠ¶æ€ç®¡ç†**: è¡¨ç¤º Claude æ­£åœ¨å¤„ç†ä¸­
- âœ… **è¶…æ—¶ä¿æŠ¤**: 10åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†
- âœ… **ç”¨æˆ·ä½“éªŒ**: "typing..." çŠ¶æ€æç¤º

---

### 2. Claude Code Hook æ•°æ®æ ¼å¼

#### ä¼ å…¥æ ¼å¼ï¼ˆstdinï¼‰

**JSON ç»“æ„**:
```json
{
  "transcript_path": "/home/user/.claude/sessions/xxx/transcript.jsonl"
}
```

**ç¤ºä¾‹ä»£ç ** (`send-to-telegram.sh:5-7`):
```bash
INPUT=$(cat)
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
```

#### Transcript æ–‡ä»¶æ ¼å¼ (`.jsonl`)

**ç»“æ„**: æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€æ¡æ¶ˆæ¯

```jsonl
{"type":"user","message":{"content":[{"type":"text","text":"Hello"}],"timestamp":"2026-01-29T..."}}
{"type":"assistant","message":{"content":[{"type":"text","text":"Hi there!"}],"timestamp":"2026-01-29T..."}}
{"type":"assistant","message":{"content":[{"type":"text","text":"How can I help?"}],"timestamp":"2026-01-29T..."}}
```

**å…³é”®å­—æ®µ**:
- `type`: `"user"` æˆ– `"assistant"`
- `message.content`: å†…å®¹å—æ•°ç»„
  - `type`: å†…å®¹ç±»å‹ï¼ˆ`"text"`, `"image"`, ç­‰ï¼‰
  - `text`: æ–‡æœ¬å†…å®¹

---

### 3. æå–æœ€åå›å¤çš„é€»è¾‘

**è„šæœ¬**: `send-to-telegram.sh:20-26`

```bash
# Step 1: æ‰¾åˆ°æœ€åä¸€ä¸ª user æ¶ˆæ¯çš„è¡Œå·
LAST_USER_LINE=$(grep -n '"type":"user"' "$TRANSCRIPT_PATH" | tail -1 | cut -d: -f1)

# Step 2: ä»è¯¥è¡Œä¹‹åæå–æ‰€æœ‰ assistant æ¶ˆæ¯
tail -n "+$LAST_USER_LINE" "$TRANSCRIPT_PATH" | \
  grep '"type":"assistant"' | \
  jq -rs '[.[].message.content[] | select(.type == "text") | .text] | join("\n\n")'
```

**é€»è¾‘**:
1. åœ¨æ•´ä¸ª transcript ä¸­æ‰¾åˆ°æœ€åä¸€ä¸ª `type="user"` çš„è¡Œå·
2. ä»è¯¥è¡Œå¼€å§‹æå–æ‰€æœ‰ `type="assistant"` çš„æ¶ˆæ¯
3. æå– assistant æ¶ˆæ¯ä¸­ `type="text"` çš„å†…å®¹
4. ç”¨ `\n\n` è¿æ¥æ‰€æœ‰æ–‡æœ¬å—

**ä¸ºä»€ä¹ˆè¿™æ ·åš**:
- âœ… Claude å¯èƒ½åˆ†å¤šæ¡ assistant æ¶ˆæ¯å›å¤
- âœ… éœ€è¦è·å– "æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰ assistant å›å¤"
- âœ… å¿½ç•¥ä¹‹å‰å¯¹è¯çš„å†…å®¹

---

## å®Œæ•´å·¥ä½œæµç¨‹

### åœºæ™¯ 1: ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ Claude å›å¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·åœ¨ Telegram å‘é€æ¶ˆæ¯                                      â”‚
â”‚    "å¸®æˆ‘ä¼˜åŒ–è¿™ä¸ªå‡½æ•°"                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Bridge Server æ”¶åˆ° Webhook (bridge.py:162-263)               â”‚
â”‚                                                                 â”‚
â”‚    - è§£ææ¶ˆæ¯å†…å®¹                                                â”‚
â”‚    - æå– chat_id, text                                         â”‚
â”‚    - å†™å…¥ CHAT_ID_FILE (line 168-169)                           â”‚
â”‚      with open(CHAT_ID_FILE, "w") as f:                         â”‚
â”‚          f.write(str(chat_id))                                  â”‚
â”‚    - åˆ›å»º PENDING_FILE (line 250-251)                           â”‚
â”‚      with open(PENDING_FILE, "w") as f:                         â”‚
â”‚          f.write(str(int(time.time())))                         â”‚
â”‚    - å¯åŠ¨ typing å¾ªç¯ (line 261)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Bridge é€šè¿‡ tmux å‘é€æ¶ˆæ¯åˆ° Claude Code (line 262-263)      â”‚
â”‚                                                                 â”‚
â”‚    tmux_send(text)      # tmux send-keys -t claude -l "..."   â”‚
â”‚    tmux_send_enter()    # tmux send-keys -t claude Enter       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Claude Code åœ¨ tmux session ä¸­å¤„ç†æ¶ˆæ¯                       â”‚
â”‚                                                                 â”‚
â”‚    - æ¥æ”¶è¾“å…¥                                                    â”‚
â”‚    - æ€è€ƒå¹¶ç”Ÿæˆå›å¤                                              â”‚
â”‚    - å®Œæˆåè§¦å‘ Stop Hook                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Claude Code è§¦å‘ Stop Hook                                   â”‚
â”‚                                                                 â”‚
â”‚    é€šè¿‡ stdin ä¼ é€’ JSON:                                        â”‚
â”‚    {"transcript_path": "~/.claude/sessions/xxx/transcript.jsonl"}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Hook è„šæœ¬å¤„ç† (send-to-telegram.sh)                          â”‚
â”‚                                                                 â”‚
â”‚    a. æ£€æŸ¥ PENDING_FILE (line 12)                               â”‚
â”‚       [ ! -f "$PENDING_FILE" ] && exit 0                        â”‚
â”‚       â†’ ä¸å­˜åœ¨å°±é€€å‡ºï¼ˆé˜²æ­¢é Telegram è¯·æ±‚è§¦å‘ï¼‰                 â”‚
â”‚                                                                 â”‚
â”‚    b. æ£€æŸ¥è¶…æ—¶ (line 16)                                        â”‚
â”‚       è¶…è¿‡ 10 åˆ†é’Ÿå°±æ¸…ç† PENDING_FILE å¹¶é€€å‡º                      â”‚
â”‚                                                                 â”‚
â”‚    c. è¯»å– CHAT_ID (line 19)                                    â”‚
â”‚       CHAT_ID=$(cat "$CHAT_ID_FILE")                            â”‚
â”‚                                                                 â”‚
â”‚    d. æ‰¾åˆ°æœ€åä¸€ä¸ª user æ¶ˆæ¯ (line 20)                          â”‚
â”‚       LAST_USER_LINE=$(grep -n '"type":"user"' ...)            â”‚
â”‚                                                                 â”‚
â”‚    e. æå–æ‰€æœ‰ assistant å›å¤ (line 24-26)                      â”‚
â”‚       tail -n "+$LAST_USER_LINE" ... | jq ...                  â”‚
â”‚                                                                 â”‚
â”‚    f. å‘é€åˆ° Telegram (line 30-71)                              â”‚
â”‚       - æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆMarkdown â†’ HTMLï¼‰                            â”‚
â”‚       - è°ƒç”¨ Telegram API                                        â”‚
â”‚       - å¤„ç†é•¿æ¶ˆæ¯æˆªæ–­ï¼ˆ4000å­—ç¬¦ï¼‰                               â”‚
â”‚                                                                 â”‚
â”‚    g. æ¸…ç† PENDING_FILE (line 73)                               â”‚
â”‚       rm -f "$TMPFILE" "$PENDING_FILE"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç”¨æˆ·åœ¨ Telegram æ”¶åˆ° Claude çš„å›å¤                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### åœºæ™¯ 2: ç”¨æˆ·ä¸­æ–­ (/stop å‘½ä»¤)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·å‘é€ /stop                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Bridge å¤„ç† /stop å‘½ä»¤ (bridge.py:179-185)                  â”‚
â”‚                                                                 â”‚
â”‚    - å‘é€ Escape é”®åˆ° tmux (ä¸­æ–­ Claude)                         â”‚
â”‚      tmux_send_escape()                                         â”‚
â”‚                                                                 â”‚
â”‚    - åˆ é™¤ PENDING_FILE                                          â”‚
â”‚      if os.path.exists(PENDING_FILE):                           â”‚
â”‚          os.remove(PENDING_FILE)                                â”‚
â”‚                                                                 â”‚
â”‚    - å›å¤ "Interrupted"                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•ˆæœ**:
- âœ… Claude åœæ­¢å¤„ç†
- âœ… Hook è„šæœ¬æ£€æŸ¥æ—¶å‘ç° PENDING_FILE ä¸å­˜åœ¨ï¼Œé€€å‡ºï¼ˆä¸å‘å›å¤ï¼‰
- âœ… typing å¾ªç¯åœæ­¢ï¼ˆ`while os.path.exists(PENDING_FILE)`ï¼‰

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. çŠ¶æ€æ–‡ä»¶æ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**: ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä½œä¸ºè¿›ç¨‹é—´é€šä¿¡ (IPC) æœºåˆ¶

**ä¼˜ç‚¹**:
- âœ… ç®€å•å¯é ï¼ˆæ— éœ€å¤æ‚ IPC æœºåˆ¶ï¼‰
- âœ… æŒä¹…åŒ–ï¼ˆé‡å¯åä»å¯æ¢å¤ï¼‰
- âœ… æ˜“äºè°ƒè¯•ï¼ˆå¯ä»¥ç›´æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼‰

**å®ç°**:
```
Bridge (Python)  â”€â”€â”€â”€â”€â”€â†’  æ–‡ä»¶ç³»ç»Ÿ  â†â”€â”€â”€â”€â”€â”€  Hook (Bash)
                           CHAT_ID_FILE
                           PENDING_FILE
```

---

### 2. æ ‡å¿—æ–‡ä»¶æ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**: æ–‡ä»¶å­˜åœ¨ = çŠ¶æ€æ¿€æ´»

**åº”ç”¨**:
- `PENDING_FILE` å­˜åœ¨ = æ­£åœ¨ç­‰å¾…å›å¤
- Hook è„šæœ¬é€šè¿‡æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§å†³å®šæ˜¯å¦æ‰§è¡Œ

**ä¼˜ç‚¹**:
- âœ… åŸå­æ€§ï¼ˆæ–‡ä»¶å­˜åœ¨æ£€æŸ¥æ˜¯åŸå­æ“ä½œï¼‰
- âœ… è‡ªåŠ¨æ¸…ç†ï¼ˆè¶…æ—¶åˆ é™¤ï¼‰
- âœ… é˜²æ­¢é‡å¤å¤„ç†

---

### 3. è¿‡æ»¤å™¨æ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**: Hook è„šæœ¬è¿‡æ»¤éé¢„æœŸçš„è§¦å‘

**å®ç°**:
```bash
# åªå“åº” Telegram å‘èµ·çš„è¯·æ±‚
[ ! -f "$PENDING_FILE" ] && exit 0
```

**æ•ˆæœ**:
- âœ… ç”¨æˆ·æœ¬åœ°æ‰‹åŠ¨ä½¿ç”¨ Claude Code â†’ Hook ä¸å›å¤ Telegram
- âœ… åªæœ‰ Bridge å‘èµ·çš„æ¶ˆæ¯æ‰ä¼šå›å¤åˆ° Telegram

---

### 4. æ•°æ®æº¯æºæ¨¡å¼

**æ ¸å¿ƒæ€æƒ³**: ä» transcript æ–‡ä»¶æå–å®Œæ•´ä¸Šä¸‹æ–‡

**å®ç°**:
- Hook ä¸ä¾èµ– CLI çš„è¾“å‡º
- ç›´æ¥ä» Claude Code çš„ transcript.jsonl è¯»å–å¯¹è¯å†å²
- æå–æœ€åä¸€ä¸ª user ä¹‹åçš„æ‰€æœ‰ assistant æ¶ˆæ¯

**ä¼˜ç‚¹**:
- âœ… å®Œæ•´å‡†ç¡®ï¼ˆç›´æ¥è·å– Claude çš„è¾“å‡ºï¼‰
- âœ… æ”¯æŒå¤šæ®µå›å¤ï¼ˆassistant å¯èƒ½åˆ†å¤šæ¡æ¶ˆæ¯ï¼‰
- âœ… æ ¼å¼ç»Ÿä¸€ï¼ˆtranscript æ˜¯æ ‡å‡†æ ¼å¼ï¼‰

---

## åº”ç”¨åˆ° clibot

### éœ€è¦å®ç°çš„æ ¸å¿ƒæœºåˆ¶

#### 1. çŠ¶æ€ç®¡ç†ï¼ˆæ›¿ä»£æ–‡ä»¶ç³»ç»Ÿï¼‰

**å½“å‰ clibot è®¾è®¡**:
- Engine ä½¿ç”¨å†…å­˜çŠ¶æ€ (`Session.State`)
- responseChan ä¼ é€’å“åº”

**å»ºè®®å¢å¼º**:
```go
type Session struct {
    Name         string
    CLIType      string
    WorkDir      string
    State        SessionState
    CreatedAt    string

    // æ–°å¢ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡
    CurrentRequest *RequestContext
}

type RequestContext struct {
    Platform      string    // "discord", "telegram"
    ChannelID     string    // å›å¤ç›®æ ‡
    Timestamp     time.Time // è¯·æ±‚æ—¶é—´
    TranscriptPath string   // Claude Code hook ä¼ é€’çš„è·¯å¾„
}
```

---

#### 2. Hook æ•°æ®å¤„ç†

**æ›´æ–° Claude CLI Adapter**:

```go
// HandleHookData å¤„ç† Claude Code hook ä¼ å…¥çš„æ•°æ®
func (c *ClaudeAdapter) HandleHookData(data map[string]interface{}) (string, error) {
    // 1. æå– transcript_path
    transcriptPath, ok := data["transcript_path"].(string)
    if !ok {
        return "", fmt.Errorf("missing transcript_path in hook data")
    }

    // 2. è§£æ transcript.jsonl
    // 3. æå–æœ€åçš„ assistant å›å¤
    // 4. è¿”å›æ–‡æœ¬å†…å®¹
    return ExtractLastAssistantResponse(transcriptPath)
}

// ExtractLastAssistantResponse ä» transcript.jsonl æå–æœ€åçš„ assistant å›å¤
func ExtractLastAssistantResponse(transcriptPath string) (string, error) {
    // å®ç°...
}
```

---

#### 3. Engine Hook å¤„ç†æ›´æ–°

**å½“å‰æµç¨‹**:
```
Hook â†’ Engine.handleHookRequest â†’ responseChan â†’ Engine.SendToAllBots
```

**æ›´æ–°åæµç¨‹**:
```
Hook â†’ Engine.handleHookRequest
  â”œâ”€ è§£æ JSON: {cli_type, data: {transcript_path}}
  â”œâ”€ è·å– session
  â”œâ”€ è°ƒç”¨ adapter.HandleHookData(data)
  â”œâ”€ è·å–å›å¤æ–‡æœ¬
  â””â”€ å‘é€åˆ° bot (session.CurrentRequest.ChannelID)
```

---

#### 4. è¿‡æ»¤æœºåˆ¶

**ç±»ä¼¼ PENDING_FILE çš„æ•ˆæœ**:

```go
// HandleUserMessage ä¸­
if session.State != StateIdle {
    // æ‹’ç»æ–°æ¶ˆæ¯ï¼ˆå·²æœ‰è¯·æ±‚åœ¨å¤„ç†ï¼‰
    return errors.New("session is busy")
}

// è®¾ç½®çŠ¶æ€
session.State = StateProcessing
session.CurrentRequest = &RequestContext{
    Platform: msg.Platform,
    ChannelID: msg.Channel,
    Timestamp: time.Now(),
}
```

**æ•ˆæœ**:
- âœ… é˜²æ­¢å¹¶å‘è¯·æ±‚
- âœ… ç¡®ä¿å›å¤å‘é€åˆ°æ­£ç¡®çš„é¢‘é“
- âœ… è¶…æ—¶è‡ªåŠ¨æ¸…ç†ï¼ˆ5åˆ†é’Ÿ timeoutï¼‰

---

### å…³é”®å·®å¼‚å¯¹æ¯”

| æ–¹é¢ | claudecode-telegram | clibot |
|------|---------------------|--------|
| **IPC æœºåˆ¶** | æ–‡ä»¶ç³»ç»Ÿ (CHAT_ID_FILE, PENDING_FILE) | å†…å­˜çŠ¶æ€ + Go channel |
| **çŠ¶æ€æ£€æŸ¥** | æ–‡ä»¶å­˜åœ¨æ€§ | Session.State |
| **å›å¤ç›®æ ‡** | ä»æ–‡ä»¶è¯»å– | Session.CurrentRequest.ChannelID |
| **è¶…æ—¶å¤„ç†** | æ—¶é—´æˆ³æ¯”è¾ƒ | select timeout |
| **è¯·æ±‚è¿‡æ»¤** | PENDING_FILE å­˜åœ¨æ€§ | Session.State == StateIdle |
| **å¹¶å‘æ§åˆ¶** | å•ä¸ª tmux session | å¤š session ç®¡ç† |

---

## æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸç†

1. **çŠ¶æ€æ–‡ä»¶**: Bridge å’Œ Hook é€šè¿‡æ–‡ä»¶ç³»ç»Ÿå…±äº«çŠ¶æ€
2. **æ ‡å¿—æ–‡ä»¶**: PENDING_FILE æ§åˆ¶æ˜¯å¦å“åº”
3. **æ•°æ®æº¯æº**: ä» transcript.jsonl è·å–å®Œæ•´å›å¤
4. **è¯·æ±‚è¿‡æ»¤**: åªå“åº”é¢„æœŸçš„è¯·æ±‚

### clibot å®ç°è·¯å¾„

1. âœ… **Hook å‘½ä»¤**: å·²æ”¯æŒ stdin JSON
2. ğŸ”„ **Transcript è§£æ**: éœ€å®ç° ExtractLastAssistantResponse
3. ğŸ”„ **çŠ¶æ€ç®¡ç†**: éœ€å¢å¼º Session ç»“æ„
4. ğŸ”„ **Hook å¤„ç†**: éœ€æ›´æ–° Engine.handleHookRequest
5. ğŸ”„ **å›å¤è·¯ç”±**: éœ€å‘é€åˆ°åŸå§‹é¢‘é“è€Œéå…¨éƒ¨ bot

---

**ä¸‹ä¸€æ­¥**: å®ç° transcript.jsonl è§£æå’Œå›å¤æå–é€»è¾‘
