# Gemini Transcript 解析逻辑

本文档总结了 Gemini CLI 适配器如何从本地历史记录中提取最新的用户输入和模型回复。

## 1. 存储机制

Gemini CLI 将对话历史存储在本地 JSON 文件中：
*   **路径**: `~/.gemini/tmp/{project_hash}/chats/session-*.json`
*   **Project Hash**: 对工程目录的全路径进行 SHA256 哈希计算得到。
*   **文件选择**: 如果 Hook 未提供具体路径，适配器会扫描目录并选择修改时间最新的 `session-*.json` 文件。

## 2. 数据结构

会话文件是一个 JSON 对象，包含消息列表：
```json
{
  "messages": [
    {"type": "user", "content": "..." },
    {"type": "gemini", "content": "...", "thoughts": [...] },
    ...
  ]
}
```

## 3. 提取逻辑 (`extractGeminiResponse`)

提取过程遵循“定位输入 -> 收集后续回复”的原则：

### 第一步：定位最新用户输入
1.  **解析文件**: 加载并反序列化 JSON 历史记录。
2.  **倒序查找**: 从 `messages` 数组末尾向前遍历。
3.  **判定条件**: 查找第一个类型 (`type`) 为 `"user"` 的消息。
4.  **记录位置**: 获取该消息的索引 `lastUserIndex` 及其内容 `userPrompt`。

### 第二步：收集助手回复
1.  **遍历范围**: 从 `lastUserIndex + 1` 开始向后遍历所有消息。
2.  **过滤规则**:
    *   仅收集类型 (`type`) 为 `"gemini"` 的消息。
    *   去除内容前后的空白字符。
3.  **合并内容**: 将所有符合条件的回复片段使用双换行符 (`

`) 进行拼接。

## 4. 总结

*   **稳定性**: 依靠消息序列中的 `user` 标签作为锚点，确保提取的是针对当前输入的最新回复。
*   **多段回复支持**: 能够自动合并模型生成过程中的多个 `gemini` 消息块。
*   **路径隔离**: 通过 `project_hash` 确保不同工程之间的对话记录互不干扰。
